import requests
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from rich.progress import track
from src.utils.logging import add_system_log

console = Console()

def vulnerability_scout(target_url):
    """Scans for sensitive files and common misconfigurations"""
    if not target_url.startswith("http"): target_url = f"http://{target_url}"
    
    sensitive_files = [
        ".env", ".git/config", "config.php", "wp-config.php", ".htaccess",
        "phpinfo.php", "info.php", "setup.php", "install.php", "backup.sql",
        "database.sql", "user.sql", "admin/", "cp/", "backup/", ".DS_Store"
    ]
    
    found = []
    add_system_log(f"[bold cyan]SCOUT:[/] Scanning {target_url} for vulnerabilities")
    
    console.print(f"\n[bold yellow]üîç Starting Vulnerability Scout on {target_url}[/bold yellow]")
    
    for path in track(sensitive_files, description="[cyan]Scanning...[/]"):
        url = f"{target_url.rstrip('/')}/{path}"
        try:
            r = requests.get(url, timeout=3, allow_redirects=False)
            if r.status_code == 200:
                if len(r.content) > 0:
                    found.append((path, r.status_code, len(r.content)))
            elif r.status_code == 403:
                found.append((path, 403, "Forbidden (Hidden)"))
        except:
            continue
            
    table = Table(title=f"Vulnerability Report: {target_url}", border_style="red")
    table.add_column("Path", style="cyan")
    table.add_column("Status", style="bold")
    table.add_column("Size / Note", style="white")
    
    if not found:
        table.add_row("No sensitive files found", "-", "-")
    else:
        for f in found:
            status_style = "green" if f[1] == 200 else "yellow"
            table.add_row(f[0], f"[{status_style}]{f[1]}[/]", str(f[2]))
            add_system_log(f"[red]VULN FOUND:[/] {f[0]} accessible on {target_url}")

    console.print(Panel(table, border_style="red"))

def brute_force_suite(target, service, username="admin"):
    """Basic credential tester for common services (SSH/FTP/HTTP)"""
    import ftplib
    common_passwords = ["admin", "password", "123456", "admin123", "root", "user", "guest"]
    add_system_log(f"[bold cyan]BRUTE:[/] Starting {service} test on {target}")
    
    found_pass = None
    
    if service.lower() == "ftp":
        for pwd in track(common_passwords, description=f"Testing {service} passwords"):
            try:
                ftp = ftplib.FTP(target, timeout=5)
                ftp.login(username, pwd)
                ftp.quit()
                found_pass = pwd
                break
            except:
                continue
    
    elif service.lower() == "http":
        for pwd in track(common_passwords, description=f"Testing {service} passwords"):
            try:
                r = requests.get(f"http://{target}", auth=(username, pwd), timeout=5)
                if r.status_code == 200:
                    found_pass = pwd
                    break
            except:
                continue
    
    if found_pass:
        msg = f"[bold green]SUCCESS![/] Found password for [cyan]{username}[/]: [yellow]{found_pass}[/]"
        console.print(Panel(msg, title="Brute Force Result", border_style="green"))
        add_system_log(f"[green]BRUTE SUCCESS:[/] Found credentials for {target}")
    else:
        console.print("[bold red]FAILED:[/] No common passwords match.")

def cve_explorer(keyword):
    """Search for CVEs using CIRCL API"""
    add_system_log(f"[bold cyan]CVE:[/] Searching CVEs for '{keyword}'")
    console.print(f"\n[bold yellow]üîç Searching CVE Database for: {keyword}[/bold yellow]")
    
    try:
        # Using CIRCL CVE Search API
        url = f"https://cve.circl.lu/api/search/{keyword}"
        resp = requests.get(url, timeout=10)
        data = resp.json()
        
        table = Table(title=f"CVE Search Results: {keyword}", border_style="magenta")
        table.add_column("CVE ID", style="cyan")
        table.add_column("Summary", style="white")
        table.add_column("CVSS", style="bold red")

        # Get first 10 results
        results = data[:10] if isinstance(data, list) else data.get('results', [])[:10]
        
        if not results:
            table.add_row("No CVEs found", "-", "-")
        else:
            for cve in results:
                table.add_row(
                    cve.get('id', 'N/A'), 
                    cve.get('summary', 'N/A')[:100] + "...", 
                    str(cve.get('cvss', 'N/A'))
                )
        
        console.print(Panel(table, border_style="magenta"))
    except Exception as e:
        console.print(f"[red]Error searching CVE database: {e}[/]")

def web_exposure_sniper(target):
    """Deep web exposure scan for sensitive files and data leaks"""
    # Reuse vulnerability_scout but with more patterns
    add_system_log(f"[bold red]SNIPER:[/] Launching deep exposure scan on {target}")
    vulnerability_scout(target)
    # Could add more logic here for deeper crawling
